<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#2196f3">
  <title>Stages</title>

  <link rel="stylesheet" href="lib/framework7-bundle.min.css">
  <link rel="stylesheet" href="css/stages.css">
  <link rel="stylesheet" href="css/performance.css">
  <link rel="stylesheet" href="css/index.css">
  <link rel="stylesheet" href="css/materialdesignicons.min.css">
  <link rel="stylesheet" href="css/remixicon/remixicon.css">

  <style>
    .stage-box {
      min-height: 80px;
      padding: 12px;
      border-radius: 8px;
      background: #fff;
      border: 1px solid #e6e6e6;
      margin-bottom: 12px
    }

    .car-info {
      text-align: center;
      font-size: 25px;
      font-weight: 600;
      color: #fffbfb;
      margin: 15px 0 25px 0;
    }
  </style>
</head>

<body>
  <div data-name="stages" class="page color-theme-blue">

    <div class="top-nav2">
      <a href="#" onclick="window.location.href='http://localhost/HUNTERSFAB/www/'; return false;">
        <img src="img/logo.png" alt="Logo" class="imagem-logo">
      </a>
    </div>

    <div class="stages-wrapper">
      <div class="stages-container">

        <div class="car-info" id="carInfo">Carregando...</div>

        <button class="stage-button stage1">Stage 1</button>
        <div class="stage-box" id="stage1_box">Carregando...</div>

        <button class="stage-button stage2">Stage 2</button>
        <div class="stage-box" id="stage2_box">Carregando...</div>

        <button class="stage-button stage3">Stage 3</button>
        <div class="stage-box" id="stage3_box">Carregando...</div>

      </div>
    </div>
  </div>

  <div id="menuPrincipal" class="toolbar toolbar-bottom">
    <div class="toolbar-inner display-flex">
      <a href="#" onclick="window.location.href='http://localhost/HUNTERSFAB/www/performace.html'; return false;">
        <i class="ri-speed-line"></i>
        <span>Performance</span>
      </a>
    </div>
  </div>

  <script>
    // ======== Funções utilitárias ===========
    function normalizar(txt) {
      return String(txt || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim()
        .toLowerCase();
    }

    // Busca exata, com fallback apenas se existir uma correspondência única semelhante
    function getBestKey(obj, key) {
      if (!obj || !key) return null;
      const target = normalizar(key);

      // 1. Match exato (ignora acentos, mas mantém pontuação)
      let exact = Object.keys(obj).find(k => normalizar(k) === target);
      if (exact) return exact;

      // 2. Fallback: se há apenas uma semelhante
      const similares = Object.keys(obj).filter(k => normalizar(k).includes(target));
      return similares.length === 1 ? similares[0] : null;
    }

    function render(id, f, m, a, v, obj) {
      const el = document.getElementById(id);
      if (!obj) {
        el.innerHTML = `<b>Não disponível</b>`;
        return;
      }
      const desc = Array.isArray(obj.descricao)
        ? `<ul>${obj.descricao.map(x => `<li>${x}</li>`).join('')}</ul>`
        : "";
      const calib = Array.isArray(obj.calibracoes_disponiveis)
        ? `<b>Calibrações:</b> ${obj.calibracoes_disponiveis.join(', ')}`
        : "";
      el.innerHTML = `
        <br>
        <b>Potência original:</b> <span class="valor-potencia">${obj.potencia_original || '-'}</span><br>
        <b>Potência:</b> <span class="valor-potencia">${obj.potencia || '-'}</span><br>
        <b>Ganho HP:</b> <span class="valor-ganho">+${obj.ganho_hp || '-'}</span><br><br>
        <b>Torque original:</b> <span class="valor-torque">${obj.torque_original || '-'}</span><br>
        <b>Torque:</b> <span class="valor-torque">${obj.torque || '-'}</span><br>
        <b>Ganho Nm:</b> <span class="valor-ganho">+${obj.ganho_nm || '-'}</span><br><br>
        ${desc}${calib}<br>`;
    }

    // =========== Lógica principal ===========
    document.addEventListener("DOMContentLoaded", async () => {
      const f = localStorage.getItem("fabricanteSelecionado") || localStorage.getItem("fabricante");
      const m = localStorage.getItem("modeloSelecionado") || localStorage.getItem("modelo");
      const a = localStorage.getItem("anoSelecionado") || localStorage.getItem("ano");
      const v = localStorage.getItem("versaoSelecionada") || localStorage.getItem("versao");

      const carInfo = document.getElementById("carInfo");
      if (!f || !m) {
        carInfo.textContent = "Nenhum veículo selecionado.";
        document.querySelectorAll(".stage-box").forEach(e => e.innerHTML = "Volte à página Performace e selecione um carro.");
        return;
      }
      carInfo.textContent = `${f} ${m} ${v || ""} ${a || ""}`;

      try {
        const res = await fetch("stages_performance.json", { cache: "no-store" });
        const data = await res.json();

        const FK = getBestKey(data, f);
        if (!FK) throw new Error(`Fabricante "${f}" não encontrado.`);

        const MK = getBestKey(data[FK], m);
        if (!MK) throw new Error(`Modelo "${m}" não encontrado em ${FK}.`);

        const VK = getBestKey(data[FK][MK], v);
        if (!VK) throw new Error(`Versão "${v}" não encontrada em ${FK} ${MK}.`);

        render("stage1_box", FK, MK, a, VK, data[FK][MK][VK]["Stage 1"]);
        render("stage2_box", FK, MK, a, VK, data[FK][MK][VK]["Stage 2"]);
        render("stage3_box", FK, MK, a, VK, data[FK][MK][VK]["Stage 3"]);
      } catch (err) {
        console.error("Erro ao carregar dados:", err);
        document.getElementById("stage1_box").innerHTML = err.message;
        document.getElementById("stage2_box").innerHTML = "";
        document.getElementById("stage3_box").innerHTML = "";
      }
    });
  </script>

  <script src="lib/framework7-bundle.min.js"></script>
  <script src="lib/jquery-3.7.0.min.js"></script>
  <script src="js/routes.js"></script>
  <script src="cordova.js"></script>
</body>

</html>